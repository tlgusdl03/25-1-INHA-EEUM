
AIR_RULES = [
    (100, "🟢 최상", "현재 공기가 최상입니다. 그대로 유지하세요."),
    (80, "🟢 양호", "공기 질이 좋습니다. 3시간 후 다시 점검하세요."),
    (60, "🟡 보통", "가벼운 환기 또는 공기청정기를 30분 가동하세요."),
    (40, "🟠 나쁨", "창문을 열어 충분히 환기하고, 소음을 줄이세요."),
    (0,  "🔴 매우 나쁨", "즉시 환기 + 마스크 착용을 권장합니다!"),
]

DI_RULES = [
    (100, "🟢 전원 쾌적",  "모든 사용자가 쾌적하게 느끼는 상태입니다. "
         "현재 설정을 유지하고, 1–2 시간 후 다시 점검하세요."),
    (80, "🟢 쾌적",  "대체로 쾌적하지만 장시간 머무를 경우 미세한 열감이 생길 수 있습니다. "
         "30 분 간격으로 환기하거나, 냉방·제습 저전력 모드를 권장합니다."),
    (60, "🟡 10% 정도 불쾌",  "일부 사용자가 더위를 느낄 수 있습니다. "
         "저소음 모드로 에어컨 또는 제습기를 가동해 실내 온·습도를 미세 조정하세요."),
    (40, "🟠 50% 정도 불쾌", "불쾌감을 느끼는 사람이 절반 수준입니다. "
         "선풍기나 서큘레이터로 공기 순환을 늘리고, 냉방 온도를 1–2 ℃ 낮춰 주세요."),
    (20,  "🟠 전원 불쾌",  "실내 체감온도가 높습니다. 에어컨을 켜고 최소 15 분 이상 급속 환기하세요. "
         "가능하면 얇은 옷차림을 권장합니다."),
    (0,  "🔴 매우 불쾌",  "에어컨을 강하게 가동하고, 실내 상대습도를 60% 이하로 낮추세요. "
         "노약자는 실내 활동을 최소화하고 수분을 자주 섭취하도록 안내하세요."),
]

NOISE_RULES = [
    (100, "🟢 쾌적",
         "조용한 공원 수준입니다. 수면에 거의 영향이 없습니다. "
         "현재 상태를 유지하면 좋습니다."),
    (80, "🟡 주의 필요",
         "일반 대화·백화점 수준 소음입니다. "
         "수면 장애가 시작될 수 있으므로 야간에는 창문을 닫고, 방음 커튼을 권장합니다."),
    (60,  "🟠 높은 소음",
         "전화 통화·TV 시청에 방해가 되는 수준입니다. "
         "작업·학습 능률이 떨어질 수 있으니 소음원을 확인하고 차단하거나 위치를 조정하세요."),
    (40, "🟠 상당한 소음",
         "철로 변 소음 수준입니다. 대화가 어렵고 청력 장애가 시작될 수 있으므로 "
         "필요 시 방음 대책(창문·도어 실링)과 휴식 시간을 늘려 주세요."),
    (20, "🔴 매우 높은 소음",
         "소음이 심한 공장 수준으로 난청 증상이 시작될 수 있습니다. "
         "방음 헤드폰 착용 또는 노출 시간을 최소화하세요."),
    (0, "🔴 극심한 소음",
         "착암기·경적 수준의 소음입니다. 귀마개 착용이 필요하며, "
         "장시간 노출은 청력 손상을 일으킬 수 있으니 즉시 장소를 이동하세요."),
]

PATTERN_TEXT: dict[str, dict[str, str]] = {
    # 🌡️ 온도 -----------------------------------------------------------------
    "temperature": {
        "EXTREME":     "온도가 하루에 **8 °C 이상** 급변했습니다. 냉·난방 설비를 즉시 점검하세요.",
        "VERY_HIGH":   "온도 변동이 **5–8 °C** 구간으로 매우 큽니다. 제어 로직을 확인하세요.",
        "HIGH":        "온도 변동이 **3–5 °C**로 다소 큽니다. 히스테리시스를 좁혀 보세요.",
        "MODERATE":    "온도 변동이 **2–3 °C** 정도로 적당합니다.",
        "STABLE":      "온도가 대체로 **안정적(1–2 °C)** 입니다.",
        "VERY_STABLE": "온도가 **매우 안정적(≤1 °C)** 입니다."
    },

    # 🔊 소음 ------------------------------------------------------------------
    "noise": {
        "EXTREME":     "소음이 **10 dB 이상** 급등락했습니다. 소음원을 즉시 점검하세요.",
        "VERY_HIGH":   "소음 변동이 **7–10 dB**로 매우 큽니다. 방음 조치가 필요합니다.",
        "HIGH":        "소음 변동이 **5–7 dB**로 큰 편입니다. 팬 속도·운영 시간을 조정하세요.",
        "MODERATE":    "소음 변동이 **3–5 dB** 정도로 적당합니다.",
        "STABLE":      "소음 변동이 **1–3 dB** 이내로 안정적입니다.",
        "VERY_STABLE": "소음 변동이 **매우 작습니다(≤1 dB)**."
    },

    # 💧 습도 ------------------------------------------------------------------
    "humidity": {
        "EXTREME":     "습도가 **30 %RH 이상** 급변했습니다. 누수·공조 시스템을 점검하세요.",
        "VERY_HIGH":   "습도 변동이 **20–30 %RH**로 매우 큽니다. 가습·제습 장치를 조정하세요.",
        "HIGH":        "습도 변동이 **15–20 %RH**로 큰 편입니다. 설비 운전을 최적화하세요.",
        "MODERATE":    "습도 변동이 **10–15 %RH** 정도로 적당합니다.",
        "STABLE":      "습도 변동이 **5–10 %RH**로 안정적입니다.",
        "VERY_STABLE": "습도 변동이 **매우 작습니다(≤5 %RH)**."
    },

    # 🧪 TVOC ------------------------------------------------------------------
    "tvoc": {
        "EXTREME":     "TVOC가 **1000 ppb 이상** 크게 출렁입니다. 즉시 환기·필터 점검 필요!",
        "VERY_HIGH":   "TVOC 변동이 **700–1000 ppb**로 매우 큽니다. 환기 주기를 늘려주세요.",
        "HIGH":        "TVOC 변동이 **500–700 ppb**로 큰 편입니다. 공기정화를 검토하세요.",
        "MODERATE":    "TVOC 변동이 **300–500 ppb** 수준입니다.",
        "STABLE":      "TVOC 변동이 **100–300 ppb**로 안정적입니다.",
        "VERY_STABLE": "TVOC 변동이 **매우 작습니다(≤100 ppb)**."
    },

    # 🌫️ PM10 -----------------------------------------------------------------
    "pm10": {
        "EXTREME":     "PM10 농도 변동이 **100 µg/m³ 이상**입니다. 즉시 대응하세요.",
        "VERY_HIGH":   "PM10 변동이 **70–100 µg/m³**로 매우 큽니다.",
        "HIGH":        "PM10 변동이 **50–70 µg/m³**로 큰 편입니다.",
        "MODERATE":    "PM10 변동이 **30–50 µg/m³**입니다.",
        "STABLE":      "PM10 변동이 **10–30 µg/m³**로 안정적입니다.",
        "VERY_STABLE": "PM10 변동이 **매우 작습니다(≤10 µg/m³)**."
    },

    # 🌁 PM2.5 -----------------------------------------------------------------
    "pm2_5": {
        "EXTREME":     "PM2.5 농도 변동이 **50 µg/m³ 이상**입니다.",
        "VERY_HIGH":   "PM2.5 변동이 **30–50 µg/m³**로 매우 큽니다.",
        "HIGH":        "PM2.5 변동이 **20–30 µg/m³**로 큰 편입니다.",
        "MODERATE":    "PM2.5 변동이 **10–20 µg/m³**입니다.",
        "STABLE":      "PM2.5 변동이 **5–10 µg/m³**로 안정적입니다.",
        "VERY_STABLE": "PM2.5 변동이 **매우 작습니다(≤5 µg/m³)**."
    },
}

def describe_pattern(metric: str, label: str) -> str:
    """패턴 라벨을 사용자 문장으로 변환 (미정의 시 기본 문구)"""
    return PATTERN_TEXT.get(metric, {}).get(
        label,
        f"{metric} 변동 패턴: {label}"
    )

def crowd_time_message(tvoc_resp) -> str:
    """
    ClusterResponse(tvoc) ➜ 가장 높은 중심값 클러스터의 time_range 반환
    """
    # ① TVOC 중심값이 가장 높은 클러스터 ID
    peak_cluster = max(tvoc_resp.cluster_centers,
                       key=lambda cid: tvoc_resp.cluster_centers[cid])
    # ② 해당 ID에 대응하는 time_range 찾기
    tr = next(p.time_range for p in tvoc_resp.peak_time
              if p.cluster_id == peak_cluster)
    return f"가장 붐빈 시간대는 **{tr.start}–{tr.end}** 입니다."